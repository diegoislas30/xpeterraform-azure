name: Import Azure Resource

on:
  workflow_dispatch:
    inputs:
      resource_type:
        description: 'Tipo de recurso a importar'
        required: true
        type: choice
        options:
          - resource_group
          - virtual_network
          - subnet
          - network_security_group
          - storage_account
          - key_vault
          - virtual_machine_linux
          - virtual_machine_windows
          - network_interface
          - managed_disk
          - public_ip
          - container_registry

      resource_name:
        description: 'Nombre del recurso en Azure'
        required: true
        type: string

      resource_group:
        description: 'Resource Group donde est√° el recurso'
        required: true
        type: string

      terraform_resource_name:
        description: 'Nombre para el recurso en Terraform (ej: prod, main, web01)'
        required: true
        type: string

      subscription_id:
        description: 'ID de la suscripci√≥n de Azure donde est√° el recurso'
        required: true
        type: string

env:
  TF_IN_AUTOMATION: true
  ARM_TENANT_ID:     ${{ secrets.AZURE_TENANT_ID }}
  ARM_CLIENT_ID:     ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_ACCESS_KEY:    ${{ secrets.ARM_ACCESS_KEY }}
  TF_VAR_admin_password: ${{ secrets.VM_PASSWORD }}

jobs:
  generate-and-pr:
    name: üìù Generar c√≥digo y crear PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: >
            {"clientId":"${{ secrets.AZURE_CLIENT_ID }}",
             "clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}",
             "subscriptionId":"${{ inputs.subscription_id }}",
             "tenantId":"${{ secrets.AZURE_TENANT_ID }}"}

      - name: Descubrir recurso y generar c√≥digo
        id: discover
        run: |
          echo "üîç Buscando recurso en Azure..."

          RESOURCE_TYPE="${{ inputs.resource_type }}"
          RESOURCE_NAME="${{ inputs.resource_name }}"
          RG="${{ inputs.resource_group }}"
          TF_NAME="${{ inputs.terraform_resource_name }}"

          case "$RESOURCE_TYPE" in

            resource_group)
              RESOURCE_ID=$(az group show -n "$RESOURCE_NAME" --query id -o tsv)
              TF_ADDRESS="azurerm_resource_group.${TF_NAME}"
              LOCATION=$(az group show -n "$RESOURCE_NAME" --query location -o tsv)
              TAGS=$(az group show -n "$RESOURCE_NAME" --query tags -o json)

              CONFIG=$(cat <<EOF
          resource "azurerm_resource_group" "$TF_NAME" {
            name     = "$RESOURCE_NAME"
            location = "$LOCATION"
            tags     = $TAGS
          }
          EOF
          )
              ;;

            virtual_network)
              RESOURCE_ID=$(az network vnet show -g "$RG" -n "$RESOURCE_NAME" --query id -o tsv)
              TF_ADDRESS="azurerm_virtual_network.${TF_NAME}"
              VNET_DATA=$(az network vnet show -g "$RG" -n "$RESOURCE_NAME" -o json)
              LOCATION=$(echo "$VNET_DATA" | jq -r '.location')
              ADDRESS_SPACE=$(echo "$VNET_DATA" | jq -r '.addressSpace.addressPrefixes | join("\", \"")' | sed 's/^/["/;s/$/"]/')
              TAGS=$(echo "$VNET_DATA" | jq '.tags')

              CONFIG=$(cat <<EOF
          resource "azurerm_virtual_network" "$TF_NAME" {
            name                = "$RESOURCE_NAME"
            resource_group_name = "$RG"
            location            = "$LOCATION"
            address_space       = $ADDRESS_SPACE
            tags                = $TAGS
          }
          EOF
          )
              ;;

            network_security_group)
              RESOURCE_ID=$(az network nsg show -g "$RG" -n "$RESOURCE_NAME" --query id -o tsv)
              TF_ADDRESS="azurerm_network_security_group.${TF_NAME}"
              NSG_DATA=$(az network nsg show -g "$RG" -n "$RESOURCE_NAME" -o json)
              LOCATION=$(echo "$NSG_DATA" | jq -r '.location')
              TAGS=$(echo "$NSG_DATA" | jq '.tags')

              CONFIG=$(cat <<EOF
          resource "azurerm_network_security_group" "$TF_NAME" {
            name                = "$RESOURCE_NAME"
            resource_group_name = "$RG"
            location            = "$LOCATION"
            tags                = $TAGS
          }
          EOF
          )
              ;;

            storage_account)
              RESOURCE_ID=$(az storage account show -g "$RG" -n "$RESOURCE_NAME" --query id -o tsv)
              TF_ADDRESS="azurerm_storage_account.${TF_NAME}"
              SA_DATA=$(az storage account show -g "$RG" -n "$RESOURCE_NAME" -o json)
              LOCATION=$(echo "$SA_DATA" | jq -r '.location')
              SKU=$(echo "$SA_DATA" | jq -r '.sku.name')
              KIND=$(echo "$SA_DATA" | jq -r '.kind')
              TIER=$(echo "$SKU" | cut -d'_' -f1)
              REPLICATION=$(echo "$SKU" | cut -d'_' -f2)
              TAGS=$(echo "$SA_DATA" | jq '.tags')

              CONFIG=$(cat <<EOF
          resource "azurerm_storage_account" "$TF_NAME" {
            name                     = "$RESOURCE_NAME"
            resource_group_name      = "$RG"
            location                 = "$LOCATION"
            account_tier             = "$TIER"
            account_replication_type = "$REPLICATION"
            account_kind             = "$KIND"
            tags                     = $TAGS
          }
          EOF
          )
              ;;

            key_vault)
              RESOURCE_ID=$(az keyvault show -g "$RG" -n "$RESOURCE_NAME" --query id -o tsv)
              TF_ADDRESS="azurerm_key_vault.${TF_NAME}"
              KV_DATA=$(az keyvault show -g "$RG" -n "$RESOURCE_NAME" -o json)
              LOCATION=$(echo "$KV_DATA" | jq -r '.location')
              TENANT_ID=$(echo "$KV_DATA" | jq -r '.properties.tenantId')
              SKU=$(echo "$KV_DATA" | jq -r '.properties.sku.name')
              TAGS=$(echo "$KV_DATA" | jq '.tags')

              CONFIG=$(cat <<EOF
          resource "azurerm_key_vault" "$TF_NAME" {
            name                = "$RESOURCE_NAME"
            resource_group_name = "$RG"
            location            = "$LOCATION"
            tenant_id           = "$TENANT_ID"
            sku_name            = "$SKU"
            tags                = $TAGS
          }
          EOF
          )
              ;;

            virtual_machine_linux)
              RESOURCE_ID=$(az vm show -g "$RG" -n "$RESOURCE_NAME" --query id -o tsv)
              TF_ADDRESS="azurerm_linux_virtual_machine.${TF_NAME}"
              VM_DATA=$(az vm show -g "$RG" -n "$RESOURCE_NAME" -o json)
              LOCATION=$(echo "$VM_DATA" | jq -r '.location')
              VM_SIZE=$(echo "$VM_DATA" | jq -r '.hardwareProfile.vmSize')
              ADMIN_USER=$(echo "$VM_DATA" | jq -r '.osProfile.adminUsername')
              TAGS=$(echo "$VM_DATA" | jq '.tags')

              # Obtener NIC ID
              NIC_ID=$(echo "$VM_DATA" | jq -r '.networkProfile.networkInterfaces[0].id')

              CONFIG=$(cat <<EOF
          resource "azurerm_linux_virtual_machine" "$TF_NAME" {
            name                  = "$RESOURCE_NAME"
            resource_group_name   = "$RG"
            location              = "$LOCATION"
            size                  = "$VM_SIZE"
            admin_username        = "$ADMIN_USER"
            network_interface_ids = ["$NIC_ID"]

            admin_ssh_key {
              username   = "$ADMIN_USER"
              public_key = "COMPLETAR_SSH_PUBLIC_KEY"
            }

            os_disk {
              caching              = "ReadWrite"
              storage_account_type = "Premium_LRS"
            }

            source_image_reference {
              publisher = "COMPLETAR"
              offer     = "COMPLETAR"
              sku       = "COMPLETAR"
              version   = "latest"
            }

            tags = $TAGS
          }
          EOF
          )
              ;;

            virtual_machine_windows)
              RESOURCE_ID=$(az vm show -g "$RG" -n "$RESOURCE_NAME" --query id -o tsv)
              TF_ADDRESS="azurerm_windows_virtual_machine.${TF_NAME}"
              VM_DATA=$(az vm show -g "$RG" -n "$RESOURCE_NAME" -o json)
              LOCATION=$(echo "$VM_DATA" | jq -r '.location')
              VM_SIZE=$(echo "$VM_DATA" | jq -r '.hardwareProfile.vmSize')
              ADMIN_USER=$(echo "$VM_DATA" | jq -r '.osProfile.adminUsername')
              TAGS=$(echo "$VM_DATA" | jq '.tags')
              NIC_ID=$(echo "$VM_DATA" | jq -r '.networkProfile.networkInterfaces[0].id')

              CONFIG=$(cat <<EOF
          resource "azurerm_windows_virtual_machine" "$TF_NAME" {
            name                  = "$RESOURCE_NAME"
            resource_group_name   = "$RG"
            location              = "$LOCATION"
            size                  = "$VM_SIZE"
            admin_username        = "$ADMIN_USER"
            admin_password        = var.vm_admin_password
            network_interface_ids = ["$NIC_ID"]

            os_disk {
              caching              = "ReadWrite"
              storage_account_type = "Premium_LRS"
            }

            source_image_reference {
              publisher = "COMPLETAR"
              offer     = "COMPLETAR"
              sku       = "COMPLETAR"
              version   = "latest"
            }

            tags = $TAGS
          }
          EOF
          )
              ;;

            *)
              echo "‚ùå Tipo de recurso no soportado: $RESOURCE_TYPE"
              exit 1
              ;;
          esac

          if [ -z "$RESOURCE_ID" ]; then
            echo "‚ùå No se pudo encontrar el recurso en Azure"
            exit 1
          fi

          echo "‚úÖ Recurso encontrado: $RESOURCE_ID"

          # Guardar outputs
          echo "resource_id=$RESOURCE_ID" >> $GITHUB_OUTPUT
          echo "terraform_address=$TF_ADDRESS" >> $GITHUB_OUTPUT

          # Guardar config para siguiente paso
          echo "$CONFIG" > /tmp/resource_config.tf

          # Generar bloque import
          cat > /tmp/import_block.tf <<EOF
          import {
            to = $TF_ADDRESS
            id = "$RESOURCE_ID"
          }
          EOF

      - name: Crear rama y agregar c√≥digo
        id: create-branch
        run: |
          BRANCH="import/${{ inputs.resource_type }}-${{ inputs.terraform_resource_name }}"
          echo "branch_name=$BRANCH" >> $GITHUB_OUTPUT

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git checkout -b "$BRANCH"

          # Agregar bloque import y configuraci√≥n a main.tf
          cat >> main.tf <<EOF

          # ============================================================================
          # IMPORT: ${{ inputs.resource_type }} - ${{ inputs.resource_name }}
          # Subscription: ${{ inputs.subscription_id }}
          # Generado: $(date -u +"%Y-%m-%d %H:%M:%S UTC") por ${{ github.actor }}
          # ============================================================================

          EOF

          cat /tmp/import_block.tf >> main.tf
          echo "" >> main.tf
          cat /tmp/resource_config.tf >> main.tf

          echo "üìù C√≥digo agregado a main.tf:"
          echo "----------------------------------------"
          tail -40 main.tf

      - name: Commit y Push
        run: |
          git add main.tf
          git commit -m "feat: Import ${{ inputs.resource_type }} - ${{ inputs.resource_name }}

          Adds import block and resource configuration for:
          - Type: ${{ inputs.resource_type }}
          - Name: ${{ inputs.resource_name }}
          - Resource Group: ${{ inputs.resource_group }}
          - Subscription: ${{ inputs.subscription_id }}

          The import will be executed when this PR is merged and
          the IAC workflow runs on main branch.

          Generated by: @${{ github.actor }}"

          git push origin "${{ steps.create-branch.outputs.branch_name }}"

      - name: Crear Pull Request
        run: |
          gh pr create \
            --title "üîÑ Import: ${{ inputs.resource_type }} - ${{ inputs.resource_name }}" \
            --body "$(cat <<'EOFPR'
          ## üì• Import de Recurso Azure

          Este PR agrega la configuraci√≥n para importar un recurso existente de Azure a Terraform.

          ### üìã Detalles del Recurso

          | Campo | Valor |
          |-------|-------|
          | **Tipo** | ${{ inputs.resource_type }} |
          | **Nombre en Azure** | ${{ inputs.resource_name }} |
          | **Resource Group** | ${{ inputs.resource_group }} |
          | **Subscription** | ${{ inputs.subscription_id }} |
          | **Nombre en Terraform** | ${{ inputs.terraform_resource_name }} |

          ### üîÑ Flujo de Import

          1. ‚úÖ Recurso encontrado en Azure
          2. ‚úÖ C√≥digo generado (bloque `import {}` + recurso)
          3. ‚è≥ **Revisar este PR** - El workflow IAC mostrar√° el plan
          4. ‚è≥ Aprobar y mergear
          5. ‚è≥ El import se ejecutar√° autom√°ticamente en main

          ### üìù Cambios en este PR

          - Se agrega bloque `import {}` en `main.tf`
          - Se agrega configuraci√≥n del recurso en `main.tf`

          ### ‚ö†Ô∏è Antes de aprobar

          1. Revisa el plan del workflow IAC en este PR
          2. Verifica que el plan muestre **"will be imported"** (no "will be created")
          3. Si hay campos marcados como "COMPLETAR", ed√≠talos antes de mergear

          ---
          **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOFPR
          )" \
            --head "${{ steps.create-branch.outputs.branch_name }}" \
            --base main
        env:
          GH_TOKEN: ${{ github.token }}

      - name: üìä Resumen
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          # ‚úÖ PR Creado para Import

          ## üìã Recurso

          | Campo | Valor |
          |-------|-------|
          | **Tipo** | ${{ inputs.resource_type }} |
          | **Nombre** | ${{ inputs.resource_name }} |
          | **Resource Group** | ${{ inputs.resource_group }} |
          | **Terraform Name** | ${{ inputs.terraform_resource_name }} |

          ## üîÑ Pr√≥ximos Pasos

          1. ‚úÖ PR creado en rama `${{ steps.create-branch.outputs.branch_name }}`
          2. ‚è≥ Revisa el plan en el workflow IAC del PR
          3. ‚è≥ Aprueba y mergea el PR
          4. ‚è≥ El import se ejecutar√° autom√°ticamente

          ## üìù C√≥digo Generado

          ```hcl
          import {
            to = ${{ steps.discover.outputs.terraform_address }}
            id = "${{ steps.discover.outputs.resource_id }}"
          }
          ```

          EOF
